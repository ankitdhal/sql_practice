CREATE DATABASE SNOW_PIPE;
USE SNOW_PIPE;

CREATE TABLE PATIENTS(
PATIENT_ID INT,
FIRST_NAME VARCHAR(100),
CITY VARCHAR(100),
REG_YEAR INT );

--CREATE STORAGE INTEGRATION

CREATE OR REPLACE STORAGE INTEGRATION S3_INT_AD
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER= S3
ENABLED= TRUE
STORAGE_AWS_ROLE_ARN ='arn:aws:iam::319724511632:role/snowpipeuserinjest'
STORAGE_ALLOWED_LOCATIONS=('s3://patientawssnowpipe/');

DESC INTEGRATION S3_INT_AD;


SELECT * FROM PATIENTS;

SHOW STAGES;

--CREATE STAGE
CREATE OR REPLACE STAGE PATIENT_SNOW_STAGE
URL = 's3://patientawssnowpipe' --NAME OF BUCKET WE HAVE CREATED
--credentials=(aws_key_id ='AKIAUU4IQ4GIAWJRFVHO' aws_secret_key='TzsUiDvX34xYeUjhRqhgdI9hj2bsPcWYZaTz0k26' )
file_format = CSV
storage_integration=S3_INT_AD;

list @PATIENT_SNOW_STAGE;

--CREATE SNOWPIPE THAT RECEOGNISES CSV THAT ARE INGESTED FROM EXTERNAL STAGE AND COPIES THE DATA INTO PATIENT TABLE

CREATE OR REPLACE PIPE PATIENT_SNOWPIPE AUTO_INGEST = TRUE AS 
COPY INTO "SNOW_PIPE"."PUBLIC"."PATIENTS"
FROM @PATIENT_SNOW_STAGE
FILE_FORMAT = (type = 'CSV');

SHOW PIPES;

ALTER PIPE PATIENT_SNOWPIPE REFRESH;

SELECT * FROM PATIENTS;

